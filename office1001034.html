<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html lang="ja">

<!--2026/02/10 17:56:22-->

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=Shift_JIS">
  <meta http-equiv="Content-Style-Type" content="text/css">
  <meta http-equiv="Content-Script-Type" content="text/javascript">
  <meta name="GENERATOR" content="ホームページV4">
  <title>6. Phase2について - Kitaya lab</title>
  <link rel="stylesheet" href="02_white_a0_0010.css" type="text/css" media="all">
</head>

<body>
  <div id="page">
  <div id="header">operanthouseのヘッダー</div>
  <div id="title">
  <h1>Kitaya lab</h1></div>
  <div id="menubar"><div class="mainmenu"><ul><li class="mainmenulistitem"><span class="mainmenuitem"><span class="mainmenuitemright"><span class="mainmenuitemcenter"><a href="index.html" class="mainmenuitemlink"><span class="mainmenuitemmark">オペラントハウスとは</span></a></span></span></span></li><li class="mainmenulistitem"><span class="mainmenuitem"><span class="mainmenuitemright"><span class="mainmenuitemcenter"><a href="office1001038.html" class="mainmenuitemlink"><span class="mainmenuitemmark">What's Operant House?</span></a></span></span></span></li><li class="mainmenulistitem"><span class="mainmenuitem"><span class="mainmenuitemright"><span class="mainmenuitemcenter"><a href="profile1.html" class="mainmenuitemlink"><span class="mainmenuitemmark">行動解析君とは?</span></a></span></span></span></li><li class="mainmenulistitem"><span class="mainmenuitem"><span class="mainmenuitemright"><span class="mainmenuitemcenter"><a href="profile1076.html" class="mainmenuitemlink"><span class="mainmenuitemmark">Mr. Behavio?</span></a></span></span></span></li><li class="mainmenulistitem"><span class="mainmenuitem"><span class="mainmenuitemright"><span class="mainmenuitemcenter"><a href="profile1001.html" class="mainmenuitemlink"><span class="mainmenuitemmark">Gait analyzer</span></a></span></span></span></li><li class="mainmenulistitem"><span class="mainmenuitem"><span class="mainmenuitemright"><span class="mainmenuitemcenter"><a href="privacy1.html" class="mainmenuitemlink"><span class="mainmenuitemmark">プライバシーポリシー</span></a></span></span></span></li></ul>
</div></div>
  <div id="side1">
  <div class="submenu"><ul><li><span class="submenuitem"><span class="submenuitemright"><span class="submenuitemcenter"><a href="index.html" class="submenuitemlink"><span class="submenuitemmark1">オペラントハウスとは?</span></a></span></span></span></li><li><span class="submenuitem"><span class="submenuitemright"><span class="submenuitemcenter"><a href="office1001.html" class="submenuitemlink"><span class="submenuitemmark1">制作の準備(ﾀﾞｳﾝﾛｰﾄﾞ)</span></a></span></span></span></li><li><span class="submenuitem"><span class="submenuitemright"><span class="submenuitemcenter"><a href="99_blank.html" class="submenuitemlink"><span class="submenuitemmark1">3Dプリンターの準備</span></a></span></span></span></li><li><span class="submenuitem"><span class="submenuitemright"><span class="submenuitemcenter"><a href="99_blank001.html" class="submenuitemlink"><span class="submenuitemmark1">オペラントハウスの製作</span></a></span></span></span></li><li><span class="submenuitem"><span class="submenuitemright"><span class="submenuitemcenter"><a href="99_blank002.html" class="submenuitemlink"><span class="submenuitemmark1">オプションパーツについて</span></a></span></span></span></li><li><span class="submenuitem"><span class="submenuitemright"><span class="submenuitemcenter"><a href="office1001018.html" class="submenuitemlink"><span class="submenuitemmark1">ｵﾍﾟﾗﾝﾄﾊｳｽの使い方</span></a></span></span></span></li><li><span class="submenuitem"><span class="submenuitemright"><span class="submenuitemcenter"><a href="99_blank003.html" class="submenuitemlink"><span class="submenuitemmark1">オリジナル課題の追加</span></a></span></span></span></li><li><span class="submenuitem" style="margin-left:10px;"><span class="submenuitemright"><span class="submenuitemcenter"><a href="office1001030.html" class="submenuitemlink"><span class="submenuitemmark2">1. 準備</span></a></span></span></span></li><li><span class="submenuitem" style="margin-left:10px;"><span class="submenuitemright"><span class="submenuitemcenter"><a href="office1001017.html" class="submenuitemlink"><span class="submenuitemmark2">2. コードの概要</span></a></span></span></span></li><li><span class="submenuitem" style="margin-left:10px;"><span class="submenuitemright"><span class="submenuitemcenter"><a href="office1001031.html" class="submenuitemlink"><span class="submenuitemmark2">3. Phase0について</span></a></span></span></span></li><li><span class="submenuitem" style="margin-left:10px;"><span class="submenuitemright"><span class="submenuitemcenter"><a href="office1001032.html" class="submenuitemlink"><span class="submenuitemmark2">4. Saveについて</span></a></span></span></span></li><li><span class="submenuitem" style="margin-left:10px;"><span class="submenuitemright"><span class="submenuitemcenter"><a href="office1001033.html" class="submenuitemlink"><span class="submenuitemmark2">5. Phase1について</span></a></span></span></span></li><li><span class="submenuitem" style="margin-left:10px;"><span class="submenuitemright"><span class="submenuitemcenter"><a href="office1001034.html" class="submenuitemlink"><span class="submenuitemmark2">6. Phase2について</span></a></span></span></span></li><li><span class="submenuitem" style="margin-left:10px;"><span class="submenuitemright"><span class="submenuitemcenter"><a href="office1001035.html" class="submenuitemlink"><span class="submenuitemmark2">7. コードの改変 その1</span></a></span></span></span></li><li><span class="submenuitem" style="margin-left:10px;"><span class="submenuitemright"><span class="submenuitemcenter"><a href="office1001067.html" class="submenuitemlink"><span class="submenuitemmark2">8. コードの改変 その2</span></a></span></span></span></li><li><span class="submenuitem" style="margin-left:10px;"><span class="submenuitemright"><span class="submenuitemcenter"><a href="office1001068.html" class="submenuitemlink"><span class="submenuitemmark2">9. レバーを使う課題に改変</span></a></span></span></span></li><li><span class="submenuitem"><span class="submenuitemright"><span class="submenuitemcenter"><a href="office1001036.html" class="submenuitemlink"><span class="submenuitemmark1">Command list</span></a></span></span></span></li><li><span class="submenuitem"><span class="submenuitemright"><span class="submenuitemcenter"><a href="office1001069.html" class="submenuitemlink"><span class="submenuitemmark1">デフォルト課題の説明</span></a></span></span></span></li><li><span class="submenuitem"><span class="submenuitemright"><span class="submenuitemcenter"><a href="office1001010.html" class="submenuitemlink"><span class="submenuitemmark1">Tips</span></a></span></span></span></li><li><span class="submenuitem"><span class="submenuitemright"><span class="submenuitemcenter"><a href="office1001037.html" class="submenuitemlink"><span class="submenuitemmark1">トラブルシューティング</span></a></span></span></span></li><li><span class="submenuitem"><span class="submenuitemright"><span class="submenuitemcenter"><a href="office1001103.html" class="submenuitemlink"><span class="submenuitemmark1">About copyright</span></a></span></span></span></li><li><span class="submenuitem"><span class="submenuitemright"><span class="submenuitemcenter"><a href="office1001070.html" class="submenuitemlink"><span class="submenuitemmark1">Go to English page</span></a></span></span></span></li></ul>
</div></div>
  <div id="side2"></div>
  <div class="HPZAutoMarginAdjuster" id="main_wrapper000">
  <div id="main">
  <h1>6. Phase2について</h1>
  <br clear="all">
  <br clear="all">
  Phase2からようやく課題の動作のコードになります。<br clear="all">
  Phase2もまずは初期化から始まります。<br clear="all">
  <br clear="all">
  <font color="Blue">=======================================================================================================================</font><br clear="all">
  <font color="Blue">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;if Phase2_Init == 0: # Initialization of the task</font><br clear="all">
  <font color="Blue">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;PutEndTaskNowButton() &nbsp; # Put &quot;TaskEnd&quot; button on Main window</font><br clear="all">
  <font color="Blue">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;mStatusVar.set('Test task (' + str(GetTaskID()) + ') &nbsp; &nbsp;Start time ' + str(TaskStartedMonth) + '/' + str(TaskStartedDay) + ' ' + str(TaskStartedHour) + ':' + str(TaskStartedMinute) + ' &nbsp; &nbsp;Running') &nbsp; &nbsp;# Substitute latest information about current task into &quot;mStatusVar&quot;</font><br clear="all">
  <font color="Blue">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;mOngoingResult = ttk.Label(MainWindowRightFrame, textvariable=mOngoingResultVar)</font><br clear="all">
  <font color="Blue">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;mOngoingResult.place(x=10, y=18)</font><br clear="all">
  <br clear="all">
  <font color="Blue">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# Substitute task parameter values in StringVars into integer or string variable (to make the cord easeir to read)</font><br clear="all">
  <font color="Blue">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;MaxCorrectNum=int(MaxCorrectNumVar.get()) &nbsp; # Get the value of &quot;MaxCorrectNumVar&quot; and convert it from string to integerand substitute into variable named &quot;MaxCorrectNum&quot;</font><br clear="all">
  <font color="Blue">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;TimeLimit = int(TimeLimitVar.get())</font><br clear="all">
  <font color="Blue">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;LickDur = int(LickDurVar.get())</font><br clear="all">
  <br clear="all">
  <font color="Blue">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# Declar local variables for this task</font><br clear="all">
  <font color="Blue">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;CorrectNum = 0</font><br clear="all">
  <font color="Blue">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;TaskDur = 0 &nbsp;# This will keep the elapsed time during of task</font><br clear="all">
  <font color="Blue">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;NowDrinking = 0</font><br clear="all">
  <br clear="all">
  <font color="Blue">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;StartRecording() &nbsp;# Start camera capture / TTL signal output</font><br clear="all">
  <font color="Blue">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;StartLickRecording() &nbsp;# Start an entry of lick log</font><br clear="all">
  <font color="Blue">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;LightCycleControlOff() &nbsp;# Deactivate automatic Light/Dark cycle illumination</font><br clear="all">
  <font color="Blue">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;RoofLightOff() &nbsp;# Turn off the lights on roof (Digital output Ch13)</font><br clear="all">
  <font color="Blue">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;InfraredLightOn() &nbsp; # Turn on the infrared LED illumination (Digital output Ch12)</font><br clear="all">
  <font color="Blue">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;DigitalOutOn(10) &nbsp; &nbsp; &nbsp; &nbsp;# Turn on cue LED connected to Ch10</font><br clear="all">
  <font color="Blue">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;ServoPosInside(3) &nbsp; # Change the angle of water arm servo connected to Ch3 to inside position</font><br clear="all">
  <font color="Blue">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;CreateNormalPanel(0) &nbsp;# Create a white-filled square panel as panel #0</font><br clear="all">
  <br clear="all">
  <font color="Blue">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Writer_TouchEventTxt = open(Path + &quot;/&quot; + str(TimeNow.year) + &quot;_&quot; + str(TimeNow.month) + &quot;_&quot; + str(TimeNow.day) + &quot; &quot; + str(TimeNow.hour) + &quot;h&quot; + str(TimeNow.minute) + &quot;m Task&quot; + str(GetTaskID()) + &quot; Touch.txt&quot;, 'w') &nbsp;# Initialize the text exporter for a resultfile</font><br clear="all">
  <font color="Blue">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Writer_TouchEventTxt.write('TrialNum\tResult\t\t\tyyyy/mm/dd\th:m\ts\n') &nbsp;# Write item name on the result file</font><br clear="all">
  <font color="Blue">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Writer_TouchEventCsv = open(Path + &quot;/&quot; + str(TimeNow.year) + &quot;_&quot; + str(TimeNow.month) + &quot;_&quot; + str(TimeNow.day) + &quot; &quot; + str(TimeNow.hour) + &quot;h&quot; + str(TimeNow.minute) + &quot;m Task&quot; + str(GetTaskID()) + &quot; Touch.csv&quot;, 'w')</font><br clear="all">
  <font color="Blue">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;print(&quot;Task #&quot; + str(GetTaskID()) + &quot; is started at &quot; + str(GetTaskStartedMonth()) + '/' + str(GetTaskStartedDay()) + ' ' + str(GetTaskStartedHour()) + ':' + str(GetTaskStartedMinute()) + ':' + str(GetTaskStartedSecond())) &nbsp;# Enter the start time in the consolewindow of Pycharm</font><br clear="all">
  <br clear="all">
  <font color="Blue">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Timer_Start(5) &nbsp;# Start a timer #5 to measure the duration of the task</font><br clear="all">
  <font color="Blue">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Phase2 = 2 &nbsp;# Start task from the reward phase</font><br clear="all">
  <font color="Blue">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Phase2_Init = 1 # Flag indicating that initialization of Phase2 has done</font><br clear="all">
  <font color="Blue">=======================================================================================================================</font><br clear="all">
  <br clear="all">
  <font color="Blue">PutEndTaskNowButton()</font>で&quot;TaskEnd&quot;ボタンをメインウィンドウに設置し、mStatusVarの内容を更新します。<br clear="all">
  次に課題の途中経過を示すラベルである<font color="Blue">mOngoingResult</font>をメインウィンドウに設置します。<br clear="all">
  <br clear="all">
  <font color="Blue">=======================================================================================================================</font><br clear="all">
  <font color="Blue">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;MaxCorrectNum=int(MaxCorrectNumVar.get()) &nbsp; # Get the value of &quot;MaxCorrectNumVar&quot; and convert it from string to integerand substitute into variable named &quot;MaxCorrectNum&quot;</font><br clear="all">
  <font color="Blue">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;TimeLimit = int(TimeLimitVar.get())</font><br clear="all">
  <font color="Blue">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;LickDur = int(LickDurVar.get())</font><br clear="all">
  <font color="Blue">=======================================================================================================================</font><br clear="all">
  <br clear="all">
  下のコードはIntVar変数のままだとコードが見づらくなるので通常のInt型の変数に課題パラメータの値を代入しています。<br clear="all">
  <br clear="all">
  <font color="Blue">=======================================================================================================================</font><br clear="all">
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<font color="Blue">CorrectNum = 0</font><br clear="all">
  <font color="Blue">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;TaskDur = 0 &nbsp;# This will keep the elapsed time during of task</font><br clear="all">
  <font color="Blue">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;NowDrinking = 0</font><br clear="all">
  <font color="Blue">=======================================================================================================================</font><br clear="all">
  <br clear="all">
  課題で使う変数を宣言します。<br clear="all">
  <br clear="all">
  <br clear="all">
  <br clear="all">
  <br clear="all">
  次はオペラントハウスの初期動作を指示します（マウスを活性化させるため課題は報酬フェーズから始まります）。<br clear="all">
  <br clear="all">
  <br clear="all">
  <font color="Blue">StartRecording()</font><br clear="all">
  カメラによる録画開始<br clear="all">
  <br clear="all">
  <font color="Blue">StartLickRecording()</font><br clear="all">
  水場ROIの検出ログの記録開始<br clear="all">
  <br clear="all">
  <font color="Blue">LightCycleControlOff()</font><br clear="all">
  <font color="Blue">RoofLightOff()</font><br clear="all">
  天井照明の明暗周期に従った点灯/消灯機能をオフ　（この時間はメインウィンドウの&quot;Setting&quot;で変えられます）にして天井照明をオフ<br clear="all">
  <br clear="all">
  <font color="Blue">InfraredLightOn()</font><br clear="all">
  赤外線照明オン<br clear="all">
  <br clear="all">
  <font color="Blue">DigitalOutOn(10)</font><br clear="all">
  デジタル入出力チャネル(10番)をオン→Cue LED点灯<br clear="all">
  <br clear="all">
  <font color="Blue">ServoPosInside(3)</font><br clear="all">
  <font color="Black">水ノズルをチャンバー内へ移動</font><br clear="all">
  <br clear="all">
  <font color="Blue">CreateNormalPanel(0)</font><br clear="all">
  <font color="Black">パネル0番を生成</font><br clear="all">
  <br clear="all">
  <br clear="all">
  <font color="Blue">Writer_TouchEventTxt = open(Path + &quot;/&quot; + str(TimeNow.year) + &quot;_&quot; + str(TimeNow.month) + &quot;_&quot; + str(TimeNow.day) + &quot; &quot; + str(TimeNow.hour) + &quot;h&quot; + str(TimeNow.minute) + &quot;m Task&quot; + str(GetTaskID()) + &quot; Touch.txt&quot;, 'w') &nbsp;# Initialize the text exporter for a result file</font><br clear="all">
  <font color="Black">次に結果ファイルであるテキストファイルを作成します。ファイルパスとファイル名をこのように指定します。</font><font color="Blue">'w'</font><font color="Black">は記入モードと言う意味です。</font><br clear="all">
  <br clear="all">
  <br clear="all">
  <font color="Blue">Writer_TouchEventTxt.write('TrialNum\tResult\t\t\tyyyy/mm/dd\th:m\ts\n') &nbsp;# Write item name on the result file</font><br clear="all">
  <font color="Black">結果ファイルに項目名を記入します。</font><br clear="all">
  <br clear="all">
  <br clear="all">
  テキストファイルと同じ要領でCSVファイルも作成します(CSVファイルとはカンマで区分けしたテキストファイルの事です)。<br clear="all">
  <br clear="all">
  <br clear="all">
  次にTimerの5番を<font color="Blue">Timer_Start(5)</font>でスタートさせます。このタイマーは課題の時間制限で使用します。<br clear="all">
  なおここで使ったタイマーですが、オペラントハウスには8つのタイマー(ID:0-7)が用意されており<font color="Blue">Timer_Start(ID)</font><font color="Black">でスタート、</font><font color="Blue">Timer_GetSec(ID)</font><font color="Black">で経過を秒で取得、</font><font color="Blue">Timer_End(ID)</font><font color="Black">でタイマーを終了させられます。</font><br clear="all">
  <br clear="all">
  <br clear="all">
  最後にPhase2を報酬フェーズである2にして初期化を終わります。<br clear="all">
  <font color="Blue">Phase2</font>はオペラント課題のフェーズの遷移状況を保持する変数です。<br clear="all">
  値が0だとトライアルの初期化フェーズ、1だとパネルのタッチフェーズ、2だと報酬フェーズ、-1だと課題終了フェーズになります。<br clear="all">
  <br clear="all">
  <br clear="all">
  <br clear="all">
  <br clear="all">
  <font color="Blue">if Phase2 == 0: &nbsp; # Initiation of new trial</font><br clear="all">
  <font color="Blue">&nbsp; TaskDur = Timer_GetSec(5)</font><br clear="all">
  <font color="Blue">&nbsp; ShowPanel(0) &nbsp; &nbsp;# Display panel #0</font><br clear="all">
  <font color="Blue">&nbsp; Phase2 = 1</font><br clear="all">
  <br clear="all">
  ここでは単に<font color="Blue">ShowPanel(0)</font>で0番パネルを表示するだけです。<br clear="all">
  <br clear="all">
  <br clear="all">
  <br clear="all">
  <br clear="all">
  また課題の経過時間もチェックし、制限時間に達したら課題終了フェーズへ移行します。<br clear="all">
  <br clear="all">
  <font color="Blue">=======================================================================================================================</font><br clear="all">
  <font color="Blue">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;if Phase2 == 1: &nbsp; # Panel presentation</font><br clear="all">
  <font color="Blue">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;TouchedPanelID = DetectRoiNosepoke() &nbsp;# Examine which panel is touched (return panel ID. If none of the panels touched,return -1)</font><br clear="all">
  <font color="Blue">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;if TouchedPanelID == 0: # If mouse touches the panel</font><br clear="all">
  <font color="Blue">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;ServoPosInside(3) &nbsp; &nbsp;# Move the water nozzle into inside position</font><br clear="all">
  <font color="Blue">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;DigitalOutOn(10) &nbsp; &nbsp;# Onset cue light</font><br clear="all">
  <font color="Blue">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;HidePanel(0)</font><br clear="all">
  <font color="Blue">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;NowDrinking = 0</font><br clear="all">
  <font color="Blue">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;CorrectNum += 1 &nbsp; &nbsp; # Increase the number of correct response</font><br clear="all">
  <font color="Blue">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;mOngoingResultVar.set('CorrectNum:' + str(CorrectNum))</font><br clear="all">
  <font color="Blue">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Writer_TouchEventTxt.write(str(CorrectNum)+'\tPanelTouched(Correct)\t'+ str(TimeNow.year)+&quot;/&quot;+str(TimeNow.month)+&quot;/&quot;+str(TimeNow.day)+&quot;\t&quot;+str(TimeNow.hour)+&quot;:&quot;+str(TimeNow.minute)+&quot;\t&quot;+str(TimeNow.second)+&quot;.&quot;+str(TimeNow.microsecond//1000)+&quot;\n&quot;) # Write the response on the text file</font><br clear="all">
  <font color="Blue">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Writer_TouchEventCsv.write(str(CorrectNum) + ',1,' + str(TimeNow.year) + &quot;,&quot; + str(TimeNow.month) + &quot;,&quot; + str(TimeNow.day) + &quot;,&quot; + str(TimeNow.hour) + &quot;,&quot; + str(TimeNow.minute) + &quot;,&quot; + str(TimeNow.second) + &quot;.&quot; + str(TimeNow.microsecond//1000)+&quot;\n&quot;) &nbsp;# Write the response on the csv file</font><br clear="all">
  <font color="Blue">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Phase2 = 2 &nbsp;# Start reward phase</font><br clear="all">
  <font color="Blue">=======================================================================================================================</font><br clear="all">
  <br clear="all">
  <font color="Blue">Phase2 == 1</font><font color="Black">では</font>マウスがパネルをタッチするまで待ち続け、タッチをしたら報酬フェーズへ移行します。<br clear="all">
  パネルタッチは<font color="Blue">DetectRoiNosepoke()</font><font color="Black">で</font>毎フレームチェックされ、タッチされた場合タッチ番号が<font color="Black">(今回は0)、そうでなければ-1が返されます。</font><br clear="all">
  <font color="Black">タッチされた場合、報酬フェーズへ移行するため以下の処理が実行されます。</font><br clear="all">
  <br clear="all">
  <font color="Blue">ServoPosInside(3)</font><br clear="all">
  <font color="Black">水ノズルをチャンバーの内側へ移動</font><br clear="all">
  <br clear="all">
  <font color="Blue">DigitalOutOn(10)</font><br clear="all">
  <font color="Black">Cue LEDをオン</font><br clear="all">
  <br clear="all">
  <font color="Blue">HidePanel(0)</font><br clear="all">
  <font color="Black">パネルを非表示</font><br clear="all">
  <br clear="all">
  <font color="Blue">mOngoingResultVar.set('CorrectNum:' + str(CorrectNum))</font><br clear="all">
  <font color="Black">途中経過ラベルを更新</font><br clear="all">
  <br clear="all">
  <font color="Blue">Writer_TouchEventTxt.write(str(CorrectNum)+'\tPanelTouched(Correct)\t'+ str(TimeNow.year)+&quot;/&quot;+str(TimeNow.month)+&quot;/&quot;+str(TimeNow.day)+&quot;\t&quot;+str(TimeNow.hour)+&quot;:&quot;+str(TimeNow.minute)+&quot;\t&quot;+str(TimeNow.second)+&quot;.&quot;+str(TimeNow.microsecond//1000)+&quot;\n&quot;) # Write the response on the text file</font><br clear="all">
  <font color="Blue">Writer_TouchEventCsv.write(str(CorrectNum) + ',1,' + str(TimeNow.year) + &quot;,&quot; + str(TimeNow.month) + &quot;,&quot; + str(TimeNow.day) + &quot;,&quot; + str(TimeNow.hour) + &quot;,&quot; + str(TimeNow.minute) + &quot;,&quot; + str(TimeNow.second) + &quot;.&quot; + str(TimeNow.microsecond//1000)+&quot;\n&quot;) &nbsp;# Write theresponse on the csv file</font><br clear="all">
  <font color="Black">正解タッチをログに記録</font><br clear="all">
  <br clear="all">
  <font color="Blue">Phase2 = 2</font><br clear="all">
  <font color="Black">報酬フェーズへ移行</font><br clear="all">
  <br clear="all">
  <br clear="all">
  <br clear="all">
  <br clear="all">
  <font color="Blue">=======================================================================================================================</font><br clear="all">
  <font color="Blue">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;if Timer_GetSec(5) &gt;= TimeLimit * 60: &nbsp; # If time limit of the task comes</font><br clear="all">
  <font color="Blue">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;TaskDur = Timer_GetSec(5)</font><br clear="all">
  <font color="Blue">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;print(&quot;Time limit elapsed&quot;)</font><br clear="all">
  <font color="Blue">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Timer_End(5) &nbsp; &nbsp;# Stop the timer</font><br clear="all">
  <font color="Blue">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Phase2 = -1</font><br clear="all">
  <font color="Blue">=======================================================================================================================</font><br clear="all">
  <br clear="all">
  <font color="Black">また同時にセッション時間が上限に達したかも</font><font color="Blue">if Timer_GetSec(5) &gt;= TimeLimit * 60:</font><font color="Black">でチェックされ、達した場合、課題終了フェーズ(</font><font color="Blue">Phase2 == -1</font><font color="Black">)へ移行します。</font><br clear="all">
  <br clear="all">
  <br clear="all">
  <br clear="all">
  <br clear="all">
  <font color="Blue">=======================================================================================================================</font><br clear="all">
  <font color="Blue">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;if Phase2 == 2: &nbsp;# Reward phase</font><br clear="all">
  <font color="Blue">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;if DetectRoiNosepoke() == 19 and NowDrinking == 0: &nbsp; &nbsp;# If the mouse initiates nose poking</font><br clear="all">
  <font color="Blue">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;NowDrinking = 1</font><br clear="all">
  <font color="Blue">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Timer_Start(0) &nbsp;# Start lick timer</font><br clear="all">
  <font color="Blue">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;if NowDrinking == 1: &nbsp; &nbsp;# If the nose poke has begun</font><br clear="all">
  <font color="Blue">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;if Timer_GetSec(0) &gt;= LickDur: &nbsp; # If the nosepoke duration exceeds the lick duration</font><br clear="all">
  <font color="Blue">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Timer_End(0) # End timer for measuring lick duration</font><br clear="all">
  <font color="Blue">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;ServoPosMiddle(3) &nbsp; # Move water nozzle back to the middle position</font><br clear="all">
  <font color="Blue">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;DigitalOutOff(10) &nbsp; # Turn off the cue LED</font><br clear="all">
  <font color="Blue">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;NowDrinking = 0</font><br clear="all">
  <font color="Blue">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;if CorrectNum &lt; MaxCorrectNum: &nbsp;# If the touch number doesn't exceed the maximum number</font><br clear="all">
  <font color="Blue">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Phase2 = 0</font><br clear="all">
  <font color="Blue">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;if CorrectNum &gt;= MaxCorrectNum: &nbsp; # If the touch number exceeds the maximum number</font><br clear="all">
  <font color="Blue">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;TaskDur = Timer_GetSec(5) &nbsp;# Keep the task time</font><br clear="all">
  <font color="Blue">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Phase2 = -1 # Go to the task finalizing phase</font><br clear="all">
  <font color="Blue">=======================================================================================================================</font><br clear="all">
  <br clear="all">
  報酬フェーズ(<font color="Blue">Phase2 == 2</font>)ではマウスが水場ROIへノーズポークした後2秒後に水ノズルをチャンバー外に出し、正解数が上限に達したかをチェック後、初期化フェーズまたは課題終了フェーズへ移行します。<br clear="all">
  水場ROIの番号は19なので<font color="Blue">DetectRoiNosepoke() == 19</font><font color="Black">で水へのアクセスの開始を検出します。アクセスを始めたらそこから一定時間後に水ノズルを外に出すので</font><font color="Blue">Timer_Start(0)</font><font color="Black">で時間計測を開始します。</font><br clear="all">
  <font color="Blue">NowDrinking == 1</font><font color="Black">では水へのアクセス時間が課題パラメータの飲水時間(</font><font color="Blue">LickDur</font><font color="Black">)を超えたかチェックし続け、もし超えた場合、水ノズルをニュートラルポジションに戻します。</font><br clear="all">
  <font color="Black">その後</font><font color="Blue">CorrectNum</font><font color="Black">(現在の正解数)と</font><font color="Blue">MaxCorrectNum</font><font color="Black">(最大正解数)の比較を行い、まだ上限に達していなければ初期化フェーズへ、達していれば経過時間を</font><font color="Blue">TaskDur</font><font color="Black">へ保持し、課題終了フェーズへ移行します。</font><br clear="all">
  <br clear="all">
  <br clear="all">
  <br clear="all">
  <br clear="all">
  <font color="Blue">=======================================================================================================================</font><br clear="all">
  <font color="Blue">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;if Phase2 == -1 or GetEndTaskNowButtonStat() == 1: &nbsp;# If the flag is set to finish the task</font><br clear="all">
  <font color="Blue">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;LightCycleControlOn() &nbsp; # Activate automatic light/dark cycle</font><br clear="all">
  <font color="Blue">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;ServoPosMiddle(3) &nbsp; # Moze servo nozzle into middle position</font><br clear="all">
  <font color="Blue">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;DeleteAllPanel() &nbsp; &nbsp;# Remove a panel on touch screen</font><br clear="all">
  <font color="Blue">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;InfraredLightOff() &nbsp;# Turn off the infrared LED</font><br clear="all">
  <font color="Blue">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;if GetRecordingStat() == 1: # If camera is capturing</font><br clear="all">
  <font color="Blue">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;SetEndRecordingTimer(60) &nbsp; &nbsp;# Onset a timer to finish video recording after 60 frames (correspond about 2sec) from now</font><br clear="all">
  <font color="Blue">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# Add summary of results into the result file</font><br clear="all">
  <font color="Blue">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Writer_TouchEventTxt.write('CorrectNum:'+str(CorrectNum)+&quot;\n&quot;)</font><br clear="all">
  <font color="Blue">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Writer_TouchEventTxt.write('SessionStartTime: ' + str(GetTaskStartedMonth()) + '/' + str(GetTaskStartedDay()) + ' ' + str(GetTaskStartedHour()) + ':' + str(GetTaskStartedMinute()) + ':' + str(GetTaskStartedSecond()) + &quot;\n&quot;)</font><br clear="all">
  <font color="Blue">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Writer_TouchEventTxt.write('SessionEndTime: ' + str(TimeNow.month) + '/' + str(TimeNow.day) + ' ' + str(TimeNow.hour) + ':' +str(TimeNow.minute) + ':' + str(TimeNow.second + (TimeNow.microsecond // 1000) / 1000) + &quot;\n&quot;)</font><br clear="all">
  <font color="Blue">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Writer_TouchEventTxt.write('TaskDuration(sec): ' + str(TaskDur) + &quot;\n&quot;)</font><br clear="all">
  <font color="Blue">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# Add experimental conditions into the result file</font><br clear="all">
  <font color="Blue">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Writer_TouchEventTxt.write('MaxCorrectNum: '+str(MaxCorrectNum)+&quot;\n&quot;)</font><br clear="all">
  <font color="Blue">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Writer_TouchEventTxt.write('TimeLimit: ' + str(TimeLimit) + &quot;\n&quot;)</font><br clear="all">
  <font color="Blue">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Writer_TouchEventTxt.write('LickDur: ' + str(LickDur)+&quot;\n&quot;)</font><br clear="all">
  <font color="Blue">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Writer_TouchEventTxt.write('RecordFPS: ' + str(GetRecordFps()) + &quot;\n&quot;) &nbsp;# Recorded frame number per second</font><br clear="all">
  <font color="Blue">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Writer_TouchEventTxt.write(GetRoiSensitivity() + &quot;\n&quot;) &nbsp;# Settings of each ROI</font><br clear="all">
  <font color="Blue">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Writer_TouchEventTxt.write(GetServoAngle() + &quot;\n&quot;) &nbsp;# Set angles of each servo</font><br clear="all">
  <br clear="all">
  <font color="Blue">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Writer_TouchEventTxt.close() &nbsp; &nbsp;# Close the text exporter for the result file</font><br clear="all">
  <font color="Blue">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Writer_TouchEventCsv.close()</font><br clear="all">
  <font color="Blue">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;EndLickRecording() &nbsp;# End lick log recording</font><br clear="all">
  <br clear="all">
  <font color="Blue">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;SendMail(DeviceNameVar.get()+' finished task '+str(GetTaskID())+'. Correct:'+str(CorrectNum)+' Dur:'+str(round(Timer_GetSec(5) / 60,1))+' min','The task is finished.') # Send a email (correct number and task duration are added to email title)</font><br clear="all">
  <br clear="all">
  <font color="Blue">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Phase = 1 &nbsp;# Go back to the task-waiting phase</font><br clear="all">
  <font color="Blue">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Phase2 = 0</font><br clear="all">
  <font color="Blue">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Phase2_Init = 0</font><br clear="all">
  <font color="Blue">=======================================================================================================================</font><br clear="all">
  <br clear="all">
  課題終了フェーズ(<font color="Blue">Phase2 == -1</font>)ではオペラントハウスを待機状態へ戻し、実験条件を結果ファイルへ書き出し、メールを送信します。<br clear="all">
  ※末尾の\nは「改行」を表します。<br clear="all">
  <br clear="all">
  <font color="Black">録画の終了は念のため現在録画しているかを</font><font color="Blue">GetRecordingStat()</font><font color="Black">でチェックし(録画中では1,そうでなければ0を返す)、録画していれば</font><font color="Blue">SetEndRecordingTimer(60)</font><font color="Black">で録画の終了を指示します。</font><br clear="all">
  <font color="Blue">SetEndRecordingTimer(60)</font><font color="Black">を実行すると60フレーム後に録画が自動的に終了します。このように遅延を入れる事で課題終了後ノズルがちゃんとチャンバーの外に出たかを後で動画でチェックできます。</font><br clear="all">
  <br clear="all">
  <br clear="all">
  <font color="Black">次の行からはテキストで以下のように結果のまとめを出力する処理です。</font><br clear="all">
  <img src="paste2503.jpg" alt="" border="0"><br clear="all">
  <font color="Black">正解数、課題開始時刻、課題終了時刻、課題時間が記入されます。</font><br clear="all">
  <br clear="all">
  <br clear="all">
  その次が課題条件です。<br clear="all">
  <img src="paste2513.jpg" alt="" border="0"><br clear="all">
  最大正解数、課題の制限時間、1回の報酬当たりの飲水時間、録画FPS(1秒間に何フレーム記録したか。この値はメインウィンドウの&quot;Setting2&quot;ボタンで変えられます)、各ROIの設定値、給水アームのサーボの設定値<br clear="all">
  <br clear="all">
  <br clear="all">
  出力するテキストファイルは最後にこのようにクローズする必要があります。<br clear="all">
  <font color="Blue">Writer_TouchEventTxt.close()</font><br clear="all">
  <br clear="all">
  <br clear="all">
  そして最後にメールを送ります。<br clear="all">
  引数にタイトルと本文を入れる事が出来ます（タイトルに結果のまとめ情報を入れておくと便利です）。<br clear="all">
  <font color="Blue">SendMail(タイトル, 本文)</font><br clear="all">
  <img src="paste249.jpg" alt="" border="0"><br clear="all">
  <br clear="all">
  <br clear="all">
  また最後にある1行<br clear="all">
  <br clear="all">
  <font color="Blue">SetDispVariable(0, 'Phase2', str(Phase2))</font><br clear="all">
  <br clear="all">
  ですが、これはプログラムの変数を値をメインウィンドウの右下に表示するために使うコマンドです。<br clear="all">
  <img src="paste2512.jpg" alt="" border="0"><br clear="all">
  <br clear="all">
  例を出した方が分かり易いと思うので例を出しますと、例えば引数を<br clear="all">
  <br clear="all">
  <font color="Blue">SetDispVariable(0, '色', 赤)</font><br clear="all">
  <font color="Blue">SetDispVariable(2, '手触り', ざらざら)</font><br clear="all">
  <font color="Blue">SetDispVariable(1, '大きさ', 1mくらい)</font><br clear="all">
  <br clear="all">
  とするとメインウィンドウでは<br clear="all">
  <br clear="all">
  <font color="DarkGreen">色:赤 大きさ:1mくらい 手触り:ざらざら</font><br clear="all">
  <br clear="all">
  と表示されます。一番左の引数は表示する順番で0-9までの整数を入れてください。<br clear="all">
  <br clear="all">
  <br clear="all">
  <br clear="all">
  <br clear="all">
  以上がこの課題のコードの説明になります。<br clear="all">
  恐らくこれをパッと読んだだけでは頭に入ってこないと思いますので是非自身でコードを色々と変更し、装置の挙動がどう変わるかを確かめてみて下さい。<br clear="all">
  <br clear="all">
  <br clear="all">
  また次章ではもう1段階複雑な課題をこのコードを改良して作成する解説を行います。</div>
  </div>
  <div id="footer">operanthouseのフッター</div>
  <div id="HPZLPPageTail" style="clear: both;"></div></div>
</body>

</html>
